<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bills, Bills, Bills!</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’µ</text></svg>">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .bill-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; color: blue; }
        .bill-item.auto { color: green; }
        .bill-item.manual { color: blue; }
        .bill-name { flex: 2; }
        .bill-amount { flex: 1; margin-right: 20px; }
        .bill-date { flex: 1; }
        .bill-actions { flex: 1; }
        .bill-icon { margin-right: 10px; }
    </style>
</head>
<body class="has-background-light">
    <div class="columns is-mobile is-centered is-fullheight m-0" style="min-height: 100vh; height: 100vh;">
        <div class="column is-2 has-background-light py-4 px-4">
        <div class="block">
                <button id="auth-button" class="button is-info" onclick="window.showLoginModal()">Login</button>
                <div id="database-selector" style="display:none;" class="select is-fullwidth">
                    <select id="database-select" onchange="window.selectDatabase(this.value)">
                        <option value="">Select Database...</option>
                    </select>
                </div>
            </div>
            <h2 class="title is-5">Filters & Reports</h2>
            <div class="reports">
                <p class="mb-2"><strong>Total Monthly:</strong> $<span id="total-monthly">0.00</span></p>
                <p><strong>Upcoming Bills:</strong></p>
                <p>This week: <span id="this-week">0</span></p>
                <p>Next week: <span id="next-week">0</span></p>
                <p>Next 21 days: <span id="next-21">0</span></p>
                <p>Next 30 days: <span id="next-30">0</span></p>
            </div>
        </div>
        <div class="column is-8 has-background-white py-4 px-4">
            <h1 class="title" style="display: inline;">Bills</h1>
            <button style="float: right;" class="button is-small is-primary" onclick="window.addBillModal()">
                <span class="icon">
                    <i class="material-icons">add</i>
                </span>
            </button>
            <div id="bills-list"></div>
        </div>
        <div class="column is-2 has-background-white py-4 px-4">
            <h2 class="title is-5">Calendar</h2>
            <div id="calendar"></div>
            <hr>
            <h2 class="title is-5">Payment History</h2>
            <div id="payment-history"></div>
        </div>
    </div>

    <!-- Modal for editing/adding bill -->
    <div id="bill-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
        <div class="modal-card" style="width: 700px;">
            <header class="modal-card-head">
                <p id="modal-title" class="modal-card-title">Add Bill</p>
                <button class="delete" aria-label="close" onclick="window.closeModal()"></button>
            </header>
            <section class="modal-card-body">
                <div class="columns">
                    <div class="column">
                        <div class="field">
                            <label class="label">Bill Name</label>
                            <div class="control has-icons-left">
                                <input class="input" type="text" id="bill-name" placeholder="Enter bill name">
                                <span class="icon is-small is-left">
                                    <i class="material-icons">payment</i>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="column">
                        <div class="field">
                            <label class="label">Amount</label>
                            <div class="control has-icons-left">
                                <input class="input" type="number" id="bill-amount" placeholder="0.00" step="0.01">
                                <span class="icon is-small is-left">
                                    <i class="material-icons">attach_money</i>
                                </span>
                            </div>
                        </div>
                        <div class="field">
                            <div class="control">
                                <label class="checkbox">
                                    <input type="checkbox" id="bill-varies">
                                    Varies
                                </label>
                            </div>
                        </div>
                        <div class="field">
                            <label class="label">Icon</label>
                            <div class="control has-icons-left">
                                <input class="input" type="text" list="icon-list" id="bill-icon" placeholder="payment">
                                <span class="icon is-small is-left" id="icon-preview">
                                    <i class="material-icons">payment</i>
                                </span>
                                <datalist id="icon-list">
                                </datalist>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="columns">
                    <div class="column">
                        <div class="field">
                            <label class="label">Frequency</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select id="bill-frequency">
                                        <option value="monthly">Monthly</option>
                                        <option value="quarterly">Quarterly</option>
                                        <option value="yearly">Yearly</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="column">
                        <div class="field">
                            <label class="label">Due Date</label>
                            <div class="control">
                                <input class="input" type="date" id="bill-due">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <div class="control">
                        <label class="checkbox">
                            <input type="checkbox" id="bill-auto">
                            Auto Payment
                        </label>
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" onclick="window.saveBill()">Save</button>
                <button class="button" onclick="window.closeModal()">Cancel</button>
            </footer>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
        <div class="modal-card" style="width: 400px;">
            <header class="modal-card-head">
                <p class="modal-card-title">Login</p>
                <button class="delete" aria-label="close" onclick="window.closeLoginModal()"></button>
            </header>
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">Username</label>
                    <div class="control has-icons-left">
                        <input class="input" type="text" id="login-username" placeholder="Username">
                        <span class="icon is-small is-left">
                            <i class="material-icons">person</i>
                        </span>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Password</label>
                    <div class="control has-icons-left">
                        <input class="input" type="password" id="login-password" placeholder="Password">
                        <span class="icon is-small is-left">
                            <i class="material-icons">lock</i>
                        </span>
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" onclick="window.login()">Login</button>
                <button class="button" onclick="window.closeLoginModal()">Cancel</button>
            </footer>
        </div>
    </div>

    <!-- Admin Modal -->
    <div id="admin-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
        <div class="modal-card" style="width: 800px; max-height: 80vh; overflow-y: auto;">
            <header class="modal-card-head">
                <p class="modal-card-title">Admin Panel</p>
                <button class="delete" aria-label="close" onclick="window.closeAdminModal()"></button>
            </header>
            <section class="modal-card-body">
                <div class="tabs">
                    <ul>
                        <li class="is-active" id="users-tab"><a onclick="window.showUsersTab()">Users</a></li>
                        <li id="db-tab"><a onclick="window.showDatabasesTab()">Databases</a></li>
                    </ul>
                </div>

                <!-- Users Tab -->
                <div id="users-section">
                    <div id="users-list"></div>
                    <div class="columns">
                        <div class="column">
                            <div class="field">
                                <label class="label">Username</label>
                                <div class="control">
                                    <input class="input" type="text" id="new-username" placeholder="Username">
                                </div>
                            </div>
                        </div>
                        <div class="column">
                            <div class="field">
                                <label class="label">Password</label>
                                <div class="control">
                                    <input class="input" type="password" id="new-password" placeholder="Password">
                                </div>
                            </div>
                        </div>
                        <div class="column">
                            <div class="field">
                                <label class="label">Role</label>
                                <div class="control">
                                    <div class="select">
                                        <select id="new-role">
                                            <option value="user">User</option>
                                            <option value="admin">Admin</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">Database Access</label>
                                <div class="control">
                                    <div class="select is-multiple">
                                        <select id="user-databases" multiple size="3">
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="button is-success" onclick="window.addUser()">Add User</button>
                </div>

                <!-- Databases Tab -->
                <div id="databases-section" style="display:none;">
                    <div id="databases-list"></div>
                    <div class="columns">
                        <div class="column">
                            <div class="field">
                                <label class="label">Database Name</label>
                                <div class="control">
                                    <input class="input" type="text" id="new-db-name" placeholder="database_name">
                                </div>
                            </div>
                        </div>
                        <div class="column">
                            <div class="field">
                                <label class="label">Display Name</label>
                                <div class="control">
                                    <input class="input" type="text" id="new-db-display-name" placeholder="Display Name">
                                </div>
                            </div>
                        </div>
                        <div class="column">
                            <div class="field">
                                <label class="label">Description</label>
                                <div class="control">
                                    <input class="input" type="text" id="new-db-description" placeholder="Optional description">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="button is-success" onclick="window.createDatabase()">Create Database</button>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button" onclick="window.closeAdminModal()">Close</button>
            </footer>
        </div>
    </div>

    <!-- Payment Edit Modal -->
    <div id="payment-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
        <div class="modal-card" style="width: 400px;">
            <header class="modal-card-head">
                <p class="modal-card-title">Edit Payment</p>
                <button class="delete" aria-label="close" onclick="window.closePaymentModal()"></button>
            </header>
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">Amount</label>
                    <div class="control has-icons-left">
                        <input class="input" type="number" id="payment-amount" placeholder="0.00" step="0.01">
                        <span class="icon is-small is-left">
                            <i class="material-icons">attach_money</i>
                        </span>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Date</label>
                    <div class="control">
                        <input class="input" type="date" id="payment-date">
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" onclick="window.savePayment()">Save</button>
                <button class="button is-danger" onclick="window.showDeleteConfirm()">Delete</button>
                <button class="button" onclick="window.closePaymentModal()">Cancel</button>
            </footer>
        </div>
    </div>

    <!-- Pay Modal -->
    <div id="pay-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
        <div class="modal-card" style="width: 500px;">
            <header class="modal-card-head">
                <p class="modal-card-title">Pay Bill</p>
                <button class="delete" aria-label="close" onclick="window.closePayModal()"></button>
            </header>
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">Payment Amount</label>
                    <div class="control has-icons-left">
                        <input class="input" type="number" id="pay-amount" placeholder="0.00" step="0.01">
                        <span class="icon is-small is-left">
                            <i class="material-icons">attach_money</i>
                        </span>
                    </div>
                </div>
                <div class="field">
                    <div class="control">
                        <label class="checkbox">
                            <input type="checkbox" id="advance-due">
                            Advance due date
                        </label>
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" onclick="window.confirmPay()">Confirm</button>
                <button class="button" onclick="window.closePayModal()">Cancel</button>
            </footer>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
        <div class="modal-card" style="width: 400px;">
            <header class="modal-card-head">
                <p class="modal-card-title">Confirm Delete</p>
                <button class="delete" aria-label="close" onclick="window.closeDeleteConfirm()"></button>
            </header>
            <section class="modal-card-body">
                <p>Are you sure you want to delete this payment?</p>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-danger" onclick="window.confirmDeletePayment()">Yes</button>
                <button class="button" onclick="window.closeDeleteConfirm()">No</button>
            </footer>
        </div>
    </div>


    <script type="text/javascript">
        window.API_URL = 'http://localhost:5000';

        window.fetchBills = function() {
            axios.get(`${window.API_URL}/bills`, { timeout: 5000 })
                .then(function(response) {
                    var bills = response.data;
                    window.renderBills(bills);
                    window.renderCalendar(bills);
                    window.updateReports(bills);
                })
                .catch(function(error) {
                    console.log('Fetch bills error:', (error.response && error.response.status) || error.code, (error.response && error.response.data) || error.message);
                    if (error.response && error.response.status === 401) {
                        // Not logged in, show empty state
                        window.renderBills([]);
                        window.renderCalendar([]);
                        window.updateReports([]);
                    } else if (error.code === 'ECONNABORTED') {
                        console.log('Request timeout - server may not be running');
                    }
                });
        }

        window.checkLoginStatus = function() {
            axios.get(`${window.API_URL}/me`)
                .then(response => {
                    window.isLoggedIn = true;
                    window.role = response.data.role;
                    window.isAdmin = (window.role === 'admin');
                    window.updateDatabaseList(response.data.databases);
                    window.updateAuthButton();
                    if (window.isAdmin && !document.getElementById('admin-button')) {
                        document.querySelector('.block').insertAdjacentHTML('beforeend', '<button id="admin-button" class="button is-warning" onclick="window.showAdminModal()">Admin</button>');
                    }
                    if (response.data.current_db) {
                        document.getElementById('database-select').value = response.data.current_db;
                    }
                    window.fetchBills();
                })
                .catch(() => {
                    window.isLoggedIn = false;
                    window.role = null;
                    window.isAdmin = false;
                    window.updateAuthButton();
                    window.updateDatabaseList([]);
                    window.fetchBills(); // Will show empty if not logged in
                });
        }

        window.updateAuthButton = function() {
            const button = document.getElementById('auth-button');
            if (window.isLoggedIn) {
                button.textContent = 'Logout';
                button.onclick = window.logout;
            } else {
                button.textContent = 'Login';
                button.onclick = window.showLoginModal;
            }
        }

        window.updateDatabaseList = function(databases) {
            const selector = document.getElementById('database-selector');
            const select = document.getElementById('database-select');
            select.innerHTML = '<option value="">Select Database...</option>';

            if (databases && databases.length > 0) {
                selector.style.display = 'block';
                databases.forEach(db => {
                    const option = document.createElement('option');
                    option.value = db.name;
                    option.textContent = db.display_name;
                    select.appendChild(option);
                });
            } else {
                selector.style.display = 'none';
            }
        }

        window.selectDatabase = function(dbName) {
            if (!dbName) return;
            axios.post(`${window.API_URL}/select-db/${dbName}`)
                .then(() => {
                    window.fetchBills();
                    alert(`Switched to database: ${dbName}`);
                })
                .catch(error => {
                    alert('Error switching database: ' + (error.response ? error.response.data.error : error.message));
                });
        }

        window.logout = function() {
            axios.post(`${window.API_URL}/logout`)
                .then(() => {
                    window.isLoggedIn = false;
                    window.role = null;
                    window.isAdmin = false;
                    const adminButton = document.getElementById('admin-button');
                    if (adminButton) adminButton.remove();
                    window.updateAuthButton();
                    window.fetchBills();
                    document.getElementById('payment-history').innerHTML = '';
                    alert('Logged out successfully');
                })
                .catch(error => {
                    console.log('Logout error:', error);
                    alert('Logout failed');
                });
        }

        window.renderBills = function(bills) {
            const list = document.getElementById('bills-list');
            list.innerHTML = `
                <div class="bill-header bill-item">
                    <span class="material-icons bill-icon">payment</span>
                    <span class="bill-name"><strong>Name</strong></span>
                    <span class="bill-amount"><strong>Amount</strong></span>
                    <span class="bill-date"><strong>Due Date</strong></span>
                    <span class="bill-actions"><strong>Actions</strong></span>
                </div>
            `;
            bills.forEach(bill => {
                const item = document.createElement('div');
                item.className = `bill-item ${bill.auto_payment ? 'auto' : 'manual'}`;
                item.style.cursor = 'pointer';
                item.onclick = () => window.showPaymentHistory(bill.name);
                const amountText = bill.amount ? '$' + bill.amount.toFixed(2) : (bill.varies ? 'Varies ($' + (bill.avg_amount || 0).toFixed(2) + ')' : '');
                item.innerHTML = `
                    <span class="material-icons bill-icon">${bill.icon || 'payment'}</span>
                    <span class="bill-name">${bill.name}</span>
                    <span class="bill-amount">${amountText}</span>
                    <span class="bill-date">${bill.next_due}</span>
                    <span class="bill-actions">
                        <button onclick="window.editBill(${bill.id}); event.stopPropagation();">Edit</button>
                        <button onclick="window.payBill(${bill.id}); event.stopPropagation();" ${bill.paid ? 'disabled' : ''}>Pay</button>
                    </span>
                `;
                list.appendChild(item);
            });
        }

        window.renderCalendar = function(bills) {
            const calendarDiv = document.getElementById('calendar');
            calendarDiv.innerHTML = '';
            const now = new Date();
            const month = now.getMonth();
            const year = now.getFullYear();
            const monthName = now.toLocaleString('default', { month: 'long' });
            calendarDiv.innerHTML += `<h3>${monthName} ${year}</h3>`;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dueDates = bills.map(b => new Date(b.next_due).getDate());
            let table = '<table style="width:100%; text-align:center;"><tr><th>S</th><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th></tr><tr>';
            for(let i = 0; i < firstDay; i++) {
                table += '<td></td>';
            }
            for(let day = 1; day <= daysInMonth; day++) {
                if ((firstDay + day - 1) % 7 === 0) table += '</tr><tr>';
                const highlighted = dueDates.includes(day) ? ' style="background-color: yellow;"' : '';
                table += `<td${highlighted}>${day}</td>`;
            }
            table += '</tr></table>';
            calendarDiv.innerHTML += table;
        }

        window.updateReports = function(bills) {
            const monthly = bills.filter(b => b.frequency === 'monthly').reduce((sum, b) => sum + (b.varies ? (b.avg_amount || 0) : parseFloat(b.amount || 0)), 0);
            document.getElementById('total-monthly').textContent = monthly.toFixed(2);

            const today = new Date();
            const oneDay = 24 * 60 * 60 * 1000;
            const endThisWeek = new Date(today.getTime() + 7 * oneDay);
            const endNextWeek = new Date(today.getTime() + 14 * oneDay);
            const end21 = new Date(today.getTime() + 21 * oneDay);
            const end30 = new Date(today.getTime() + 30 * oneDay);

            const countInRange = (start, end) => bills.filter(b => {
                const due = new Date(b.next_due);
                return due >= start && due < end && !b.archived;
            }).length;

            document.getElementById('this-week').textContent = countInRange(today, endThisWeek);
            document.getElementById('next-week').textContent = countInRange(endThisWeek, endNextWeek);
            document.getElementById('next-21').textContent = countInRange(today, end21);
            document.getElementById('next-30').textContent = countInRange(today, end30);
        }

        window.addBillModal = function() {
            // Check if logged in first
            if (!window.isLoggedIn) {
                window.showLoginModal();
                return;
            }
            document.getElementById('modal-title').textContent = 'Add Bill';
            document.getElementById('bill-modal').style.display = 'flex';
            // Reset fields
            document.getElementById('bill-name').value = '';
            document.getElementById('bill-amount').value = '';
            document.getElementById('bill-icon').value = 'payment';
            document.getElementById('bill-due').value = '';
            document.getElementById('bill-auto').checked = false;
            window.editingId = null;
        }

        window.closeModal = function() {
            document.getElementById('bill-modal').style.display = 'none';
            // Reset modal content if needed
        }

        window.payBill = function(id) {
            window.payingId = id;
            document.getElementById('pay-amount').value = '';
            document.getElementById('advance-due').checked = true;
            document.getElementById('pay-modal').style.display = 'flex';
        }

        window.closePayModal = function() {
            document.getElementById('pay-modal').style.display = 'none';
        }

        window.confirmPay = function() {
            const amount = parseFloat(document.getElementById('pay-amount').value);
            const advance_due = document.getElementById('advance-due').checked;
            if (amount > 0) {
                axios.post(`${window.API_URL}/bills/${window.payingId}/pay`, {amount, advance_due})
                    .then(() => {
                        window.closePayModal();
                        window.fetchBills();
                        alert('Payment recorded' + (advance_due ? ' and next bill added' : ''));
                    })
                    .catch(error => {
                        alert('Error recording payment');
                    });
            } else {
                alert('Please enter a valid amount');
            }
        }

        window.saveBill = function() {
            const name = document.getElementById('bill-name').value.trim();
            const dueDate = document.getElementById('bill-due').value;
            const varies = document.getElementById('bill-varies').checked;

            if (!name || !dueDate) {
                alert('Please fill in all required fields');
                return;
            }

            const data = {
                name: name,
                amount: varies ? null : parseFloat(document.getElementById('bill-amount').value),
                varies: varies,
                frequency: document.getElementById('bill-frequency').value,
                next_due: dueDate,
                auto_payment: document.getElementById('bill-auto').checked,
                icon: document.getElementById('bill-icon').value.trim() || 'payment'
            };

            console.log('Saving bill:', data);  // Debug log

            if (window.editingId) {
                axios.put(`${window.API_URL}/bills/${window.editingId}`, data, { timeout: 5000 })
                    .then(response => {
                        console.log('Bill updated:', response.data);
                        window.fetchBills();
                    })
                    .catch(error => {
                        console.log('Save error:', (error.response && error.response.status) || '', (error.response && error.response.data) || '');
                        alert('Failed to update bill');
                    });
            } else {
                axios.post(`${window.API_URL}/bills`, data, { timeout: 5000 })
                    .then(response => {
                        console.log('Bill created:', response.data);
                        window.fetchBills();
                    })
                    .catch(error => {
                        console.log('Save error:', (error.response && error.response.status) || '', (error.response && error.response.data) || '');
                        alert('Failed to create bill');
                    });
            }
            window.closeModal();
        }

        window.editBill = function(id) {
            // Check if logged in first
            if (!window.isLoggedIn) {
                window.showLoginModal();
                return;
            }
            // Since SPA, fetch the bill to edit
            axios.get(`${window.API_URL}/bills`).then(response => {
                const bill = response.data.find(b => b.id == id);
                if (bill) {
                    document.getElementById('modal-title').textContent = 'Edit Bill';
                    document.getElementById('bill-modal').style.display = 'flex';
                    document.getElementById('bill-name').value = bill.name;
                    document.getElementById('bill-amount').value = bill.amount || '';
                    document.getElementById('bill-icon').value = bill.icon || 'payment';
                    document.getElementById('bill-frequency').value = bill.frequency;
                    document.getElementById('bill-due').value = bill.next_due;
                    document.getElementById('bill-auto').checked = bill.auto_payment;
                    document.getElementById('bill-varies').checked = bill.varies || false;
                    const input = document.getElementById('bill-amount');
                    input.disabled = bill.varies || false;
                    input.style.opacity = (bill.varies || false) ? '0.5' : '1';
                    window.editingId = id;
                }
            });
        }

        window.showLoginModal = function() {
            document.getElementById('login-modal').style.display = 'flex';
        }

        window.closeLoginModal = function() {
            document.getElementById('login-modal').style.display = 'none';
        }

        window.login = function() {
            var username = document.getElementById('login-username').value;
            var password = document.getElementById('login-password').value;

            console.log('Attempting login for:', username);  // Debug log

            axios.post(`${window.API_URL}/login`, {username, password}, {
                timeout: 5000,
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(function(response) {
                    console.log('Login successful:', response.data);  // Debug log
                    alert('Login successful!');
                    window.isLoggedIn = true;
                    window.role = response.data.role;
                    window.isAdmin = (window.role === 'admin');
                    window.updateAuthButton();
                    window.updateDatabaseList(response.data.databases);
                    if (window.isAdmin && !document.getElementById('admin-button')) {
                        document.querySelector('.block').insertAdjacentHTML('beforeend', '<button id="admin-button" class="button is-warning" onclick="window.showAdminModal()">Admin</button>');
                    }
                    window.closeLoginModal();
                    window.fetchBills(); // Refresh data after login
                })
                .catch(function(error) {
                    console.log('Login error:', (error.response && error.response.status) || error.code, (error.response && error.response.data) || error.message);  // Debug log
                    if (error.response && error.response.status === 401) {
                        alert('Invalid credentials');
                    } else if (error.code === 'ECONNABORTED') {
                        alert('Login timeout - server may not be running');
                    } else {
                        alert('Login failed: ' + (error.response ? error.response.data.error : 'Unknown error'));
                    }
                });
        }

        window.showAdminModal = function() {
            if(!window.isAdmin) return;
            document.getElementById('admin-modal').style.display = 'flex';
            window.showUsersTab(); // Start with users tab
        }

        window.closeAdminModal = function() {
            document.getElementById('admin-modal').style.display = 'none';
        }

        window.showUsersTab = function() {
            document.getElementById('users-tab').classList.add('is-active');
            document.getElementById('db-tab').classList.remove('is-active');
            document.getElementById('users-section').style.display = 'block';
            document.getElementById('databases-section').style.display = 'none';
            window.fetchUsers();
            window.populateDatabaseSelectOptions();
        }

        window.showDatabasesTab = function() {
            document.getElementById('db-tab').classList.add('is-active');
            document.getElementById('users-tab').classList.remove('is-active');
            document.getElementById('databases-section').style.display = 'block';
            document.getElementById('users-section').style.display = 'none';
            window.fetchDatabases();
        }

        window.fetchDatabases = function() {
            axios.get(`${window.API_URL}/databases`)
                .then(response => {
                    const list = document.getElementById('databases-list');
                    list.innerHTML = '';
                    response.data.forEach(db => {
                        list.innerHTML += `<p><strong>${db.display_name}</strong> (${db.name}) - ${db.description}</p>`;
                    });
                }).catch(error => {
                    alert('Error fetching databases: ' + error.message);
                });
        }

        window.createDatabase = function() {
            const name = document.getElementById('new-db-name').value.trim();
            const displayName = document.getElementById('new-db-display-name').value.trim();
            const description = document.getElementById('new-db-description').value.trim();

            if (!name || !displayName) {
                alert('Database name and display name are required');
                return;
            }

            axios.post(`${window.API_URL}/databases`, {name, display_name: displayName, description})
                .then(() => {
                    window.fetchDatabases();
                    document.getElementById('new-db-name').value = '';
                    document.getElementById('new-db-display-name').value = '';
                    document.getElementById('new-db-description').value = '';
                    alert('Database created successfully!');
                }).catch(error => {
                    alert('Error creating database: ' + (error.response ? error.response.data.error : error.message));
                });
        }

        window.fetchUsers = function() {
            axios.get(`${window.API_URL}/users`)
                .then(response => {
                    const list = document.getElementById('users-list');
                    list.innerHTML = '';
                    response.data.forEach(user => {
                        list.innerHTML += `<p>${user.username} (${user.role}) <button onclick="window.deleteUser(${user.id})">Delete</button></p>`;
                    });
                }).catch(error => {
                    alert('Error fetching users: ' + error.message);
                });
        }

        window.populateDatabaseSelectOptions = function() {
            axios.get(`${window.API_URL}/databases`)
                .then(response => {
                    const select = document.getElementById('user-databases');
                    select.innerHTML = '';
                    response.data.forEach(db => {
                        const option = document.createElement('option');
                        option.value = db.id;
                        option.textContent = db.display_name;
                        select.appendChild(option);
                    });
                }).catch(error => {
                    console.log('Error populating database options:', error);
                });
        }

        window.addUser = function() {
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;

            // Get selected database IDs
            const dbSelect = document.getElementById('user-databases');
            const selectedOptions = Array.from(dbSelect.selectedOptions);
            const databaseIds = selectedOptions.map(option => parseInt(option.value));

            const data = {
                username,
                password,
                role,
                database_ids: databaseIds
            };

            axios.post(`${window.API_URL}/users`, data)
                .then(() => {
                    window.fetchUsers();
                    document.getElementById('new-username').value = '';
                    document.getElementById('new-password').value = '';
                    // Note: Don't clear role or database selection in case creating multiple similar users
                }).catch(error => {
                    alert('Error adding user: ' + (error.response ? error.response.data.error : error.message));
                });
        }

        window.deleteUser = function(id) {
            axios.delete(`${window.API_URL}/users/${id}`)
                .then(() => {
                    window.fetchUsers();
                }).catch(error => {
                    alert('Error deleting user: ' + (error.response ? error.response.data.error : error.message));
                });
        }

        window.showPaymentHistory = function(name) {
            window.currentBillName = name;
            axios.get(`${window.API_URL}/bills/${encodeURIComponent(name)}/payments`)
                .then(response => {
                    const historyDiv = document.getElementById('payment-history');
                    historyDiv.innerHTML = '';
                    response.data.forEach(payment => {
                        const item = document.createElement('div');
                        item.style.cursor = 'pointer';
                        item.onclick = () => window.editPayment(payment.id, payment.amount, payment.payment_date);
                        item.innerHTML = `
                            <p><span class="material-icons" style="font-size: 16px; vertical-align: middle;">edit</span> $${payment.amount.toFixed(2)} on ${payment.payment_date}</p>
                        `;
                        historyDiv.appendChild(item);
                    });
                })
                .catch(error => {
                    console.log('Error fetching payments:', error);
                });
        }

        window.editPayment = function(id, amount, date) {
            document.getElementById('payment-amount').value = amount;
            document.getElementById('payment-date').value = date;
            document.getElementById('payment-modal').style.display = 'flex';
            window.editingPaymentId = id;
        }

        window.closePaymentModal = function() {
            document.getElementById('payment-modal').style.display = 'none';
        }

        window.savePayment = function() {
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const date = document.getElementById('payment-date').value;
            axios.put(`${window.API_URL}/payments/${window.editingPaymentId}`, {amount, payment_date: date})
                .then(() => {
                    window.closePaymentModal();
                    window.showPaymentHistory(window.currentBillName);
                    window.fetchBills();
                    alert('Payment updated');
                })
                .catch(error => {
                    alert('Error updating payment');
                });
        }

        window.showDeleteConfirm = function() {
            document.getElementById('delete-confirm-modal').style.display = 'flex';
        }

        window.closeDeleteConfirm = function() {
            document.getElementById('delete-confirm-modal').style.display = 'none';
        }

        window.confirmDeletePayment = function() {
            axios.delete(`${window.API_URL}/payments/${window.editingPaymentId}`)
                .then(() => {
                    window.closeDeleteConfirm();
                    window.closePaymentModal();
                    window.showPaymentHistory(window.currentBillName);
                    window.fetchBills();
                    alert('Payment deleted');
                })
                .catch(error => {
                    alert('Error deleting payment');
                });
        }

        // Load bills on start and set up events
        document.addEventListener('DOMContentLoaded', () => {
            window.checkLoginStatus();
            const commonIcons = ['payment', 'credit_card', 'account_balance', 'account_balance_wallet', 'home', 'car', 'phone', 'wifi', 'shopping_cart', 'restaurant', 'local_gas_station', 'lightbulb', 'school', 'medical_services', 'fitness_center', 'movie', 'music_note', 'flight', 'train', 'bus', 'directions_car', 'local_shipping', 'work', 'business', 'store', 'local_drink', 'movie_creation', 'camera', 'palette', 'sports_soccer', 'golf_course', 'pool', 'beach_access', 'camping', 'access_time', 'alarm', 'event', 'cake', 'gift', 'shopping_bag', 'local_offer', 'loyalty', 'star', 'grade', 'thumb_up'];
            const datalist = document.getElementById('icon-list');
            commonIcons.forEach(icon => {
                const option = document.createElement('option');
                option.value = icon;
                datalist.appendChild(option);
            });
            document.getElementById('bill-varies').addEventListener('change', function() {
                const input = document.getElementById('bill-amount');
                input.disabled = this.checked;
                input.style.opacity = this.checked ? '0.5' : '1';
            });
            document.getElementById('bill-icon').addEventListener('input', function() {
                const icon = this.value.trim() || 'payment';
                document.getElementById('icon-preview').innerHTML = `<i class="material-icons">${icon}</i>`;
            });
        });


    </script>
</body>
</html>
